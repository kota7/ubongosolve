<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ubongo Puzzle Solver</title>
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h1>ðŸ§© Ubongo Puzzle Solver</h1>

    <!-- ===== Board Editor ===== -->
    <section class="panel">
      <h2>1. Define the Board</h2>
      <p class="hint">Click cells to toggle. The shaded cells form your board.</p>
      <div class="board-controls">
        <label>Rows: <input type="number" id="grid-rows" value="7" min="1" max="12"></label>
        <label>Cols: <input type="number" id="grid-cols" value="8" min="1" max="12"></label>
        <button onclick="resizeGrid()">Resize</button>
        <button onclick="clearGrid()">Clear</button>
      </div>
      <table id="board-grid" class="grid"></table>
    </section>

    <!-- ===== Piece Selector ===== -->
    <section class="panel">
      <h2>2. Choose Pieces</h2>

      <div class="piece-subsection">
        <h3>Predefined Pieces</h3>
        <p class="hint">Click to add / remove.</p>
        <div class="predefined-pieces">
          {% for name, coords in predefined_pieces.items() %}
          <div class="piece-card" data-name="{{ name }}"
               data-coords='{{ coords | tojson }}'
               onclick="togglePredefined(this)">
            <div class="piece-name">{{ name }}</div>
            <table class="piece-preview"></table>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="piece-subsection">
        <h3>Custom Piece</h3>
        <p class="hint">Draw a piece on the mini-grid, then click "Add".</p>
        <div class="board-controls">
          <label>Rows: <input type="number" id="custom-rows" value="4" min="1" max="6"></label>
          <label>Cols: <input type="number" id="custom-cols" value="4" min="1" max="6"></label>
          <button onclick="resizeCustomGrid()">Resize</button>
          <button onclick="clearCustomGrid()">Clear</button>
        </div>
        <table id="custom-grid" class="grid small-grid"></table>
        <button class="btn" onclick="addCustomPiece()">Add Custom Piece</button>
      </div>

      <div class="piece-subsection">
        <h3>Selected Pieces</h3>
        <div id="selected-pieces" class="selected-pieces">
          <p class="hint" id="no-pieces-msg">No pieces selected yet.</p>
        </div>
      </div>
    </section>

    <!-- ===== Solve ===== -->
    <section class="panel">
      <h2>3. Solve</h2>
      <button class="btn btn-solve" id="solve-btn" onclick="submitSolve()">
        Solve Puzzle
      </button>
      <div id="result"></div>
    </section>
  </div>

  <script>
    // ===================================================================
    // State
    // ===================================================================
    let selectedPieces = []; // [{name, coords: [[r,c], ...]}, ...]

    // ===================================================================
    // Board Grid
    // ===================================================================
    function buildGrid(tableId, rows, cols, cellClass) {
      const table = document.getElementById(tableId);
      table.innerHTML = "";
      for (let r = 0; r < rows; r++) {
        const tr = document.createElement("tr");
        for (let c = 0; c < cols; c++) {
          const td = document.createElement("td");
          td.className = cellClass + " off";
          td.dataset.r = r;
          td.dataset.c = c;
          td.addEventListener("click", () => {
            td.classList.toggle("on");
            td.classList.toggle("off");
          });
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
    }

    function resizeGrid() {
      const rows = parseInt(document.getElementById("grid-rows").value);
      const cols = parseInt(document.getElementById("grid-cols").value);
      buildGrid("board-grid", rows, cols, "board-cell");
    }

    function clearGrid() {
      document.querySelectorAll("#board-grid .board-cell").forEach(td => {
        td.classList.remove("on");
        td.classList.add("off");
      });
    }

    // ===================================================================
    // Custom Piece Grid
    // ===================================================================
    function resizeCustomGrid() {
      const rows = parseInt(document.getElementById("custom-rows").value);
      const cols = parseInt(document.getElementById("custom-cols").value);
      buildGrid("custom-grid", rows, cols, "custom-cell");
    }

    function clearCustomGrid() {
      document.querySelectorAll("#custom-grid .custom-cell").forEach(td => {
        td.classList.remove("on");
        td.classList.add("off");
      });
    }

    function addCustomPiece() {
      const cells = document.querySelectorAll("#custom-grid .custom-cell.on");
      if (cells.length === 0) return;
      const coords = Array.from(cells).map(td => [+td.dataset.r, +td.dataset.c]);
      // Normalize: shift to (0,0) origin
      const minR = Math.min(...coords.map(c => c[0]));
      const minC = Math.min(...coords.map(c => c[1]));
      const normalized = coords.map(c => [c[0] - minR, c[1] - minC]);
      const name = "Custom " + (selectedPieces.filter(p => p.name.startsWith("Custom")).length + 1);
      selectedPieces.push({ name, coords: normalized });
      clearCustomGrid();
      renderSelectedPieces();
    }

    // ===================================================================
    // Predefined Pieces
    // ===================================================================
    function togglePredefined(card) {
      const name = card.dataset.name;
      const idx = selectedPieces.findIndex(p => p.name === name);
      if (idx >= 0) {
        selectedPieces.splice(idx, 1);
        card.classList.remove("selected");
      } else {
        const coords = JSON.parse(card.dataset.coords);
        selectedPieces.push({ name, coords });
        card.classList.add("selected");
      }
      renderSelectedPieces();
    }

    function renderPiecePreview(table, coords) {
      table.innerHTML = "";
      if (!coords.length) return;
      const maxR = Math.max(...coords.map(c => c[0]));
      const maxC = Math.max(...coords.map(c => c[1]));
      const set = new Set(coords.map(c => c[0] + "," + c[1]));
      for (let r = 0; r <= maxR; r++) {
        const tr = document.createElement("tr");
        for (let c = 0; c <= maxC; c++) {
          const td = document.createElement("td");
          td.className = set.has(r + "," + c) ? "preview-on" : "preview-off";
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
    }

    // ===================================================================
    // Selected Pieces
    // ===================================================================
    function renderSelectedPieces() {
      const container = document.getElementById("selected-pieces");
      const msg = document.getElementById("no-pieces-msg");
      // Clear existing piece tags (keep the msg element)
      container.querySelectorAll(".piece-tag").forEach(el => el.remove());

      if (selectedPieces.length === 0) {
        msg.style.display = "";
        return;
      }
      msg.style.display = "none";

      selectedPieces.forEach((p, i) => {
        const tag = document.createElement("div");
        tag.className = "piece-tag";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = p.name + " (" + p.coords.length + " cells)";

        const preview = document.createElement("table");
        preview.className = "piece-preview";
        renderPiecePreview(preview, p.coords);

        const removeBtn = document.createElement("button");
        removeBtn.textContent = "âœ•";
        removeBtn.className = "remove-btn";
        removeBtn.onclick = () => {
          selectedPieces.splice(i, 1);
          // Deselect predefined card if applicable
          const card = document.querySelector(`.piece-card[data-name="${p.name}"]`);
          if (card) card.classList.remove("selected");
          renderSelectedPieces();
        };

        tag.appendChild(preview);
        tag.appendChild(nameSpan);
        tag.appendChild(removeBtn);
        container.appendChild(tag);
      });
    }

    // ===================================================================
    // Solve
    // ===================================================================
    function getBoardData() {
      const cells = document.querySelectorAll("#board-grid .board-cell.on");
      return Array.from(cells).map(td => [+td.dataset.r, +td.dataset.c]);
    }

    function submitSolve() {
      const board = getBoardData();
      const pieces = selectedPieces.map(p => p.coords);
      const payload = JSON.stringify({ board, pieces });

      const btn = document.getElementById("solve-btn");
      btn.disabled = true;
      btn.textContent = "Solving...";

      fetch("/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: payload,
      })
        .then(resp => resp.text())
        .then(html => {
          document.getElementById("result").innerHTML = html;
        })
        .catch(err => {
          document.getElementById("result").innerHTML =
            '<div class="error">Request failed: ' + err.message + "</div>";
        })
        .finally(() => {
          btn.disabled = false;
          btn.textContent = "Solve Puzzle";
        });
    }

    // ===================================================================
    // Init
    // ===================================================================
    document.addEventListener("DOMContentLoaded", () => {
      resizeGrid();
      resizeCustomGrid();

      // Render predefined piece previews
      document.querySelectorAll(".piece-card").forEach(card => {
        const coords = JSON.parse(card.dataset.coords);
        const table = card.querySelector(".piece-preview");
        renderPiecePreview(table, coords);
      });
    });
  </script>
</body>
</html>
